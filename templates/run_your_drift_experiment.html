{% include "header.html" %}

{% block content %}
<h1>Run Drift Experiment on Your Data</h1>
<form enctype="multipart/form-data" onsubmit="handleSubmit(event)">
    Dataset name: <input type="text" id="dataset-name" name="dataset" placeholder="Enter dataset name" onkeyup="checkInputs()">
    <br><br>
    Model name: <input type="text" id="model-name" name="model" placeholder="Enter model name" onkeyup="checkInputs()">
    <br><br><br>
    <div class="input-group">
        Baseline Data: <input type="file" class="upload-btn" id="baseline-upload" accept=".hdf5" disabled onchange="handleFileSelect(event, 'baseline')">
        <button type="button" id="compute-baseline-btn" disabled>Compute Baseline</button>
    </div>
    <br>

    <div class="input-group">
        Threshold Data: <input type="file" class="upload-btn" id="threshold-upload" accept=".hdf5" disabled onchange="handleFileSelect(event, 'threshold')">
        <button type="button" id="estimate-threshold-btn" disabled>Estimate Threshold</button>
    </div>
    <br>

    Data Stream: <input type="file" class="upload-btn" id="datastream-upload" accept=".hdf5" disabled onchange="handleFileSelect(event, 'datastream')">
    <br><br><br>
    <button type="submit" id="submit-btn" disabled>Upload Data</button>
</form>

<script type="text/javascript">
    let uploadsInProgress = { baseline: false, threshold: false, datastream: false };

    function checkInputs() {
        var dataset = document.getElementById('dataset-name').value;
        var model = document.getElementById('model-name').value;
        var allFilled = dataset && model;

        var uploadButtons = document.getElementsByClassName('upload-btn');
        for (var i = 0; i < uploadButtons.length; i++) {
            uploadButtons[i].disabled = !allFilled;
        }

        checkSubmitButton();
    }

    function handleFileSelect(event, uploadType) {
        const file = event.target.files[0];
        if (file) {
            chunkAndUploadFile(file, uploadType);
            uploadsInProgress[uploadType] = true;
            updateUIForUpload(uploadType, true);
            checkSubmitButton();
        }
    }

async function chunkAndUploadFile(file, uploadType) {
    const chunkSize = 5 * 1024 * 1024; // e.g., 5MB
    let start = 0;

    while (start < file.size) {
        let end = Math.min(start + chunkSize, file.size);
        let chunk = file.slice(start, end);
        let formData = new FormData();
        formData.append('fileChunk', chunk, file.name);
        formData.append('uploadType', uploadType);

        // Add model name and dataset name to form data
        formData.append('modelName', document.getElementById('model-name').value);
        formData.append('datasetName', document.getElementById('dataset-name').value);

        await fetch('/upload_chunk', {
            method: 'POST',
            body: formData
        }).then(response => response.json())
          .then(data => {
            console.log(data.message);
          })
          .catch(error => {
            console.error('Error:', error);
          });

        start = end;
    }

    uploadsInProgress[uploadType] = false;
    updateUIForUpload(uploadType, false);

    // Check if the completed upload is for baseline data
    if (uploadType === 'baseline') {
        document.getElementById('compute-baseline-btn').disabled = false;
    }

    // Check if the completed upload is for threshold data
    if (uploadType === 'threshold') {
        document.getElementById('estimate-threshold-btn').disabled = false;
    }



    checkSubmitButton();
}


    function updateUIForUpload(uploadType, isUploading) {
        // Select all input elements and buttons
        /*var inputs = document.getElementsByTagName('input');
        var buttons = document.getElementsByTagName('button');

        // Disable or enable all inputs and buttons based on isUploading
        for (var i = 0; i < inputs.length; i++) {
            inputs[i].disabled = isUploading;
        }
        for (var i = 0; i < buttons.length; i++) {
            buttons[i].disabled = isUploading;
        }

        // Special handling for the upload button of the current upload type
        if (!isUploading) {
            document.getElementById(uploadType + '-upload').disabled = false;
        }*/
    }


    function checkSubmitButton() {
        var allUploadsCompleted = Object.values(uploadsInProgress).every(status => status === false);
        var datasetFilled = document.getElementById('dataset-name').value !== '';
        var modelFilled = document.getElementById('model-name').value !== '';

        document.getElementById('submit-btn').disabled = !(allUploadsCompleted && datasetFilled && modelFilled);
    }

    function handleSubmit(event) {
        event.preventDefault();
        // Handle form submission logic here
    }


</script>
{% endblock %}

{% include "footer.html" %}
