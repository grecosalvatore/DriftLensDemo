{% include "header.html" %}

{% block content %}
<h1>Run Drift Experiment on Your Data</h1>
<form enctype="multipart/form-data" onsubmit="handleSubmit(event)">
    Dataset name: <input type="text" id="dataset-name" name="dataset" placeholder="Enter dataset name" onkeyup="checkInputs()">
    <br><br>
    Model name: <input type="text" id="model-name" name="model" placeholder="Enter model name" onkeyup="checkInputs()">
    <br><br><br>
    Baseline Data: <input type="file" class="upload-btn" id="baseline-upload" accept=".hdf5" disabled onchange="uploadData('baseline')">
    <br><br>
    Threshold Data: <input type="file" class="upload-btn" id="threshold-upload" accept=".hdf5" disabled onchange="uploadData('threshold')">
    <br><br>
    New Data: <input type="file" class="upload-btn" id="newdata-upload" accept=".hdf5" disabled onchange="uploadData('newdata')">
    <br><br>
    Drift Data: <input type="file" class="upload-btn" id="drift-upload" accept=".hdf5" disabled onchange="uploadData('drift')">
    <br><br><br>
    <button type="submit" id="submit-btn" disabled>Submit</button>
</form>

<script type="text/javascript">
    let uploadsCompleted = { baseline: false, threshold: false, newdata: false, drift: false };

    function checkInputs() {
        var dataset = document.getElementById('dataset-name').value;
        var model = document.getElementById('model-name').value;
        var allFilled = dataset && model;

        var uploadButtons = document.getElementsByClassName('upload-btn');
        for (var i = 0; i < uploadButtons.length; i++) {
            uploadButtons[i].disabled = !allFilled;
        }

        checkSubmitButton();
    }

    function uploadData(type) {
        // Update the code here to handle the file upload process
        console.log('Uploading ' + type);
        uploadsCompleted[type] = true;

        // Check if all uploads are completed
        checkSubmitButton();
    }

    function checkSubmitButton() {
        var allUploadsCompleted = Object.values(uploadsCompleted).every(status => status === true);
        var datasetFilled = document.getElementById('dataset-name').value !== '';
        var modelFilled = document.getElementById('model-name').value !== '';

        document.getElementById('submit-btn').disabled = !(allUploadsCompleted && datasetFilled && modelFilled);
    }

function handleSubmit(event) {
    event.preventDefault();
    var files = [
        document.getElementById('baseline-upload').files[0],
        document.getElementById('threshold-upload').files[0],
        document.getElementById('newdata-upload').files[0],
        document.getElementById('drift-upload').files[0]
    ];

    files.forEach(file => {
        if (file) {
            chunkAndUploadFile(file);
        }
    });
}

function chunkAndUploadFile(file) {
    const chunkSize = 5 * 1024 * 1024; // e.g., 5MB
    let start = 0;

    while (start < file.size) {
        let end = Math.min(start + chunkSize, file.size);
        let chunk = file.slice(start, end);
        let formData = new FormData();
        formData.append('fileChunk', chunk, file.name);
        // You might want to append additional data to identify the chunk number or total chunks

        fetch('/upload_chunk', {
            method: 'POST',
            body: formData
        }).then(response => response.json())
          .then(data => {
            console.log(data.message); // You can update the UI to show progress here
          })
          .catch(error => {
            console.error('Error:', error);
          });

        start = end;
    }
}

</script>
{% endblock %}

{% include "footer.html" %}
